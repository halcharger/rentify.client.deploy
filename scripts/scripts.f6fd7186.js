"use strict";var app=angular.module("rentify",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","LocalStorageModule","angular-loading-bar","services.config","toastr","angular-data.DSCacheFactory","ui.bootstrap","flow"]);app.config(["$httpProvider",function(a){a.interceptors.push("authInterceptorService")}]),app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/dashboard.html"}).when("/login",{templateUrl:"views/login.html",controller:"loginController"}).when("/signup",{templateUrl:"views/signup.html",controller:"signupController"}).when("/mysites",{templateUrl:"views/mysites.html",controller:"mysitesController"}).when("/addsite",{templateUrl:"views/addsite.html",controller:"addSiteController"}).when("/deletesite",{templateUrl:"views/deletesite.html",controller:"deletesiteController"}).when("/editsite-theme",{templateUrl:"views/editsitetheme.html",controller:"editSiteThemeController"}).when("/editsite-pages",{templateUrl:"views/editSitePages.html",controller:"editSitePagesController"}).when("/property-overview",{templateUrl:"views/editsitepropertydetailsoverview.html",controller:"editSitePropertyDetailsOverviewController"}).when("/property-location",{templateUrl:"views/editSitePropertyLocation.html",controller:"editSitePropertyLocationController"}).otherwise({redirectTo:"/"})}]),angular.module("services.config",[]).constant("configuration",{serverBaseUri:"http://rentifywebapidev01.azurewebsites.net/",clientId:"rentifyAngularMainApp",environment:"DEV"}),app.run(["authService",function(a){a.fillAuthData()}]),app.factory("authService",["$q","$injector","$location","localStorageService","configuration",function(a,b,c,d,e){var f,g=e.serverBaseUri,h={},i={isAuth:!1,userName:"",useRefreshTokens:!1},j={provider:"",userName:"",email:"",externalAccessToken:""},k=function(a){return n(),f=f||b.get("$http"),f.post(g+"api/account/register",a).then(function(a){return a})},l=function(){i.isAuth||c.path("login")},m=function(a){var c="grant_type=password&username="+a.userName+"&password="+a.password;return a.useRefreshTokens&&(c=c+"&client_id="+e.clientId),f=f||b.get("$http"),console.log("about to post to:"+g+"token"),f.post(g+"token",c,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){a.useRefreshTokens?d.set("authorizationData",{token:b.access_token,userName:a.userName,refreshToken:b.refresh_token,useRefreshTokens:!0}):d.set("authorizationData",{token:b.access_token,userName:a.userName,refreshToken:"",useRefreshTokens:!1}),i.isAuth=!0,i.userName=a.userName,i.useRefreshTokens=a.useRefreshTokens}).error(function(){n()})},n=function(){d.remove("authorizationData"),i.isAuth=!1,i.userName="",i.useRefreshTokens=!1},o=function(){var a=d.get("authorizationData");a&&(i.isAuth=!0,i.userName=a.userName,i.useRefreshTokens=a.useRefreshTokens)},p=function(){console.log("refreshing token...");var c=a.defer(),h=d.get("authorizationData");if(h&&h.useRefreshTokens){var i="grant_type=refresh_token&refresh_token="+h.refreshToken+"&client_id="+e.clientId;d.remove("authorizationData"),f=f||b.get("$http"),f.post(g+"token",i,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){d.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:a.refresh_token,useRefreshTokens:!0}),c.resolve(a)}).error(function(){c.reject()})}else c.reject();return c.promise},q=function(a){return f=f||b.get("$http"),f.get(g+"api/account/ObtainLocalAccessToken",{params:{provider:a.provider,externalAccessToken:a.externalAccessToken}}).success(function(a){d.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:"",useRefreshTokens:!1}),i.isAuth=!0,i.userName=a.userName,i.useRefreshTokens=!1}).error(function(){n()})},r=function(a){return f=f||b.get("$http"),f.post(g+"api/account/registerexternal",a).success(function(a){d.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:"",useRefreshTokens:!1}),i.isAuth=!0,i.userName=a.userName,i.useRefreshTokens=!1}).error(function(){n()})};return h.saveRegistration=k,h.login=m,h.logOut=n,h.fillAuthData=o,h.authentication=i,h.refreshToken=p,h.obtainAccessToken=q,h.externalAuthData=j,h.registerExternal=r,h.redirectToLoginIfNotAuthenticated=l,h}]),app.factory("authInterceptorService",["$rootScope","$q","$location","$injector","localStorageService",function(a,b,c,d,e){function f(b){console.log("global generic error handler: rejection:",b);var c="<p>We are sorry but you experienced an unexpected error. We have done all we can to notify the right people so all you can do right now is try again.</p>";if(b.data||0!=b.status||""!==b.statusText)if(400==b.status)if(b.data&&b.data.error_description)c=b.data.error_description;else if(b.data&&"The request is invalid."==b.data.message&&b.data.modelState){var d=[];for(var e in b.data.modelState)for(var f=0;f<b.data.modelState[e].length;f++)d.push(b.data.modelState[e][f]);c="<strong>Failed to save changes due to:</strong><BR/>"+d.join("<br/>")}else b.data&&b.data.message&&(c=b.data.message);else 500==b.status&&b.data.exceptionMessage&&(c=c+"<p><strong>Exception Type:</strong></p><p>"+b.data.exceptionType+"</p>");else c="Unable to connect to the server, please try again in a couple of seconds.";a.$broadcast("globalErrorEvent",c)}var g,h={},i=function(b){b=b||{},b.headers=b.headers||{};var c=e.get("authorizationData");return c&&(b.headers.Authorization="Bearer "+c.token),a.$broadcast("globalClearErrorEvent"),b},j=function(a){var e=b.defer();if(401===a.status){var g=d.get("authService");g.refreshToken().then(function(){k(a.config,e)},function(b){console.log("failed to refresh token: ",b),g.logOut(),c.path("/login"),e.reject(a)})}else f(a),e.reject(a);return e.promise},k=function(a,b){g=g||d.get("$http"),g(a).then(function(a){b.resolve(a)},function(a){b.reject(a)})};return h.request=i,h.responseError=j,h}]),app.factory("tokensManagerService",["$http","configuration",function(a,b){var c=b.serverBaseUri,d={},e=function(){return a.get(c+"api/RefreshTokens").then(function(a){return a})},f=function(b){return a["delete"](c+"api/refreshtokens/?tokenid="+b).then(function(a){return a})};return d.deleteRefreshTokens=f,d.getRefreshTokens=e,d}]),function(){function a(a,b,c,d,e){c.redirectToLoginIfNotAuthenticated();var f,g="mysites",h=d.serverBaseUri;e(g,{maxAge:9e4,cacheFlushInterval:6e5,deleteOnExpire:"aggressive"});var i={};return i.getMySites=function(){var c=b.defer(),d=(new Date).getTime(),f=e.get(g);return f.get(g)?c.resolve(f.get(g)):a.get(h+"api/mysites").success(function(a){console.log("time taken for mysites request: "+((new Date).getTime()-d)+"ms"),f.put(g,a),c.resolve(a)}),c.promise},i.refreshMySites=function(){return a.get(h+"api/mysites").success(function(a){var b=e.get(g);return b.put(g,a),a})},i.addSite=function(b){return a.post(h+"api/mysites/add",b).success(function(){var a=e.get(g),c=a.get(g);c.push(b),a.put(g,c)})},i.updateTheme=function(b,c){return a.post(h+"api/site/updatetheme",{uniqueId:b,themeId:c}).success(function(){refreshMySites()})},i.deleteSite=function(b){return a["delete"](h+"api/mysites/delete?uniqueId="+b).success(function(){for(var a=e.get(g),c=a.get(g),d=c.length-1;d>=0;d--)c[d].uniqueId===b&&c.splice(d,1);a.put(g,c)})},i.getPropertyOverview=function(b){return a.get(h+"api/site/propertyoverview?siteUniqueId="+b)},i.updatePropertyOverview=function(b){return a.post(h+"api/site/updatepropertyoverview",b)},i.getLocation=function(b){return a.get(h+"api/site/location?siteUniqueId="+b)},i.updateLocation=function(b){return a.post(h+"api/site/updatelocation",b)},i.setSelectedSite=function(a){f=a},i.getSelectedSite=function(){return f},i.clearSelectedSite=function(){f={}},i}app.factory("sitesService",["$http","$q","authService","configuration","DSCacheFactory",a])}(),function(){function a(a){function b(){return(new Date).toUTCString()}var c={positionClass:"toast-bottom-right"},d={};return d.info=function(d){a.info(d,b(),c)},d.error=function(d){a.error(d,b(),c)},d.success=function(d){a.success(d,b(),c)},d.warning=function(d){a.warning(d,b(),c)},d}angular.module("rentify").factory("notificationService",["toastr",a])}(),function(){function a(a,b,c,d,e,f){function g(a,b){for(var c=e.get(i),d=c.get(b),f=d.length-1;f>=0;f--)d[f].id===a.id&&d.splice(f,1);c.put(i,d)}function h(a,b){g(a,b);var c=e.get(i),d=c.get(b);d.push(a),c.put(b,d)}c.redirectToLoginIfNotAuthenticated();var i="pages",j=d.serverBaseUri,k={};return e(i,{maxAge:9e4,cacheFlushInterval:6e5,deleteOnExpire:"aggressive"}),k.getPages=function(){var c=f.getSelectedSite().uniqueId,d=b.defer(),g=(new Date).getTime(),h=e.get(i);return h.get(c)?d.resolve(h.get(c)):a.post(j+"api/"+c+"/pages").success(function(a){console.log("time taken for pages request: "+((new Date).getTime()-g)+"ms"),h.put(c,a),d.resolve(a)}),d.promise},k.refreshPages=function(){var b=f.getSelectedSite().uniqueId;return a.post(j+"api/"+b+"/pages").success(function(a){var c=e.get(i);return c.put(b,a),a})},k.savePage=function(b){var c=f.getSelectedSite().uniqueId;return a.post(j+"api/"+c+"/save",b).success(function(a){h(a,c)})},k.deletePage=function(b){var c=f.getSelectedSite().uniqueId;return a["delete"](j+"api/"+c+"/delete?webPageId="+b.id).success(function(){g(b,c)})},k}app.factory("pagesService",["$http","$q","authService","configuration","DSCacheFactory","sitesService",a])}(),function(){function a(a,b,c,d){var e={};e.environment=d.environment,e.logOut=function(){c.logOut(),b.path("/login")},e.authentication=c.authentication,a.vm=e}app.controller("indexController",["$scope","$location","authService","configuration",a])}(),app.controller("loginController",["$scope","$location","configuration","authService",function(a,b,c,d){var e={},f=c.serverBaseUri,g=c.clientId;e.loginData={userName:"",password:"",useRefreshTokens:!1},e.message="",e.login=function(){return console.log("entering login function"),e.message="",d.login(e.loginData).success(function(){b.path("/mysites")})},e.authExternalProvider=function(b){var c=location.protocol+"//"+location.host+"/authcomplete.html",d=f+"api/Account/ExternalLogin?provider="+b+"&response_type=token&client_id="+g+"&redirect_uri="+c;window.$windowScope=a;window.open(d,"Authenticate Account","location=0,status=0,width=600,height=750")},a.authCompletedCB=function(c){a.$apply(function(){if("False"==c.haslocalaccount)console.log("external account is not linked to a local account, linking..."),d.logOut(),d.externalAuthData={provider:c.provider,userName:c.external_user_name,email:c.external_email,externalAccessToken:c.external_access_token},a.registerData={userName:d.externalAuthData.email,email:d.externalAuthData.email,provider:d.externalAuthData.provider,externalAccessToken:d.externalAuthData.externalAccessToken},console.log("about to post registerData: ",a.registerData),d.registerExternal(a.registerData).success(function(){b.path("/orders")}).error(function(a,b,c,d){console.log("Error encountered associating external login with local app account:",a,b,d),e.message=a.error_description});else{console.log("external account is linked to a local account, logging in...");var f={provider:c.provider,externalAccessToken:c.external_access_token};d.obtainAccessToken(f).then(function(){b.path("/orders")},function(a,b,c,d){console.log("Error encountered logging in (authCompletedCB): ",a,b,d),e.message=a.error_description})}})},a.vm=e}]),app.controller("signupController",["$scope","$location","$timeout","authService","notificationService",function(a,b,c,d,e){var f={};f.savedSuccessfully=!1,f.message="",f.registration={email:"",password:"",confirmPassword:""},f.signUp=function(){return f.registration.userName=f.registration.email,d.saveRegistration(f.registration).then(function(){f.savedSuccessfully=!0,e.success("User has been registered successfully, you will be redirected to login page in 2 seconds."),g()})};var g=function(){var a=c(function(){c.cancel(a),b.path("/login")},2e3)};a.vm=f}]),function(){function a(a,b,c,d){c.redirectToLoginIfNotAuthenticated();var e={};e.sites=[],e.message="",e.loadingSites=!0,e.getSites=function(){e.loadingSites=!0,d.getMySites().then(function(a){e.sites=a,e.loadingSites=!1},function(a,b,c,d){console.log("Getting MySites failed: ",a,b,d),e.message="Getting My Sites failed. "+(a.message?a.message:""),e.loadingSites=!1})},e.refreshSites=function(){return e.loadingSites=!0,d.refreshMySites().success(function(a){e.sites=a,e.loadingSites=!1}).error(function(){e.message="Refreshing My Sites failed.",e.loadingSites=!1})},e.deleteSite=function(a){d.setSelectedSite(a),b.path("deletesite")},e.editSite=function(a){d.setSelectedSite(a),b.path("editsite-theme")},e.getSites(),a.vm=e}app.controller("mysitesController",["$scope","$location","authService","sitesService",a])}(),function(){function a(a,b,c,d,e){c.redirectToLoginIfNotAuthenticated();var f={};f.message="",f.site={name:"",uniqueId:""},f.addSite=function(){return d.addSite(f.site).success(function(){e.success("New site ["+f.site.name+"] successully added."),d.setSelectedSite(f.site),b.path("editsite-theme")})},a.vm=f}app.controller("addSiteController",["$scope","$location","authService","sitesService","notificationService",a])}(),function(){function a(a,b,c,d,e){c.redirectToLoginIfNotAuthenticated();var f={};f.message="",f.site=d.getSelectedSite(),f.site||b.path("mysites"),f.cancel=function(){d.clearSelectedSite(),b.path("mysites")},f.deleteSite=function(){return d.deleteSite(f.site.uniqueId).success(function(){e.success("The site: "+f.site.name+" was successully deleted."),f.cancel()}).error(function(a,b,c,d){console.log("Error encountered deleting site:",a,b,d),f.message=a.error_description})},a.vm=f}app.controller("deletesiteController",["$scope","$location","authService","sitesService","notificationService",a])}(),function(){function a(a,b,c,d,e,f,g){function h(){i.page={},i.configurePage=!1}if(d.redirectToLoginIfNotAuthenticated(),!e.getSelectedSite())return void b.path("mysites");var i={};i.message="",i.configurePage=!1,i.pages=[],i.page,console.log("pages: ",i.pages),i.addPage=function(){var a={menuText:"",title:"",content:""};i.page=a,i.configurePage=!0},i.editPage=function(a){i.page=a,i.configurePage=!0},i.deletePage=function(a){i.page=a;var b=c.open({templateUrl:"deletePageModalContent.html",controller:"SimpleDeleteModalInstanceController",resolve:{objToDelete:function(){return i.page}}});b.result.then(function(){f.deletePage(i.page).success(function(){g.success("Successfully deleted page titled: "+i.page.title)})},function(){})},i.savePage=function(){return f.savePage(i.page).success(function(){h()}).error(function(a,b,c,d){console.log("Error encountered saving page: ",a,b,d);var e="";a.error_description&&(e="Error Description: "+a.error_description),a.message&&(e=(e?e+", Message: ":"Message: ")+a.message),a.messageDetail&&(e=e+", Message Detail: "+a.messageDetail),a.exceptionMessage&&(e=e+", Exception Message: "+a.exceptionMessage),e||(e="Error encountered trying to save the page details."),i.message=e})},i.cancel=function(){console.log("switching back"),h()},i.getPages=function(){f.getPages(e.getSelectedSite().uniqueId).then(function(a){i.pages=a},function(){console.log("Error encountered getting pages.")})},i.getPages(),a.vm=i}app.controller("PagesController",["$scope","$location","$modal","authService","sitesService","pagesService","notificationService",a])}(),function(){function a(a,b,c,d){b.redirectToLoginIfNotAuthenticated();var e={};e.themes=["lavilla"],e.site=c.getSelectedSite(),e.selectedTheme=e.site.themeId,e.save=function(){return c.updateTheme(e.site.uniqueId,e.selectedTheme).success(function(){d.success("Successfully updated site theme for "+e.site.name+".")})},a.vm=e}app.controller("editSiteThemeController",["$scope","authService","sitesService","notificationService",a])}(),function(){function a(a,b,c,d,e){c.redirectToLoginIfNotAuthenticated();var f={};return f.propertyOverview={},f.site=d.getSelectedSite(),f.site&&f.site.uniqueId?(f.loadPropertyOverviewData=function(){return d.getPropertyOverview(f.site.uniqueId).success(function(a){f.propertyOverview=a})},f.save=function(){return f.propertyOverview.uniqueId=f.site.uniqueId,d.updatePropertyOverview(f.propertyOverview).success(function(){e.success("Property Overview successfully saved.")})},a.vm=f,void f.loadPropertyOverviewData()):void b.path("mysites")}app.controller("editSitePropertyDetailsOverviewController",["$scope","$location","authService","sitesService","notificationService",a])}(),function(){function a(a,b,c){b.redirectToLoginIfNotAuthenticated();var d={};d.site=c.getSelectedSite(),a.vm=d}app.controller("editSitePagesController",["$scope","authService","sitesService",a])}(),function(){function a(a,b,c){var d={};d.objToDelete=c,d.ok=function(){b.close()},d.cancel=function(){b.dismiss("cancel")},a.vm=d}app.controller("SimpleDeleteModalInstanceController",["$scope","$modalInstance","objToDelete",a])}(),function(){function a(a,b,c,d,e){c.redirectToLoginIfNotAuthenticated();var f={};return f.location={},f.site=d.getSelectedSite(),f.site&&f.site.uniqueId?(f.loadData=function(){return d.getLocation(f.site.uniqueId).success(function(a){f.location=a})},f.save=function(){return f.location.uniqueId=f.site.uniqueId,d.updateLocation(f.location).success(function(){e.success("Property Location successfully saved.")})},f.mapImageUploadSuccess=function(a){console.log("map image upload success: "+a)},a.vm=f,void f.loadData()):void b.path("mysites")}app.controller("editSitePropertyLocationController",["$scope","$location","authService","sitesService","notificationService",a])}(),function(){app.directive("spinnerButton",function(){return{restrict:"E",scope:{buttonclass:"@",text:"@",spinnertext:"@",isdisabled:"=",click:"&"},controller:["$scope",function(a){a.isClicked=!1,a.buttonClick=function(){a.isClicked=!0,a.click()["finally"](function(){a.isClicked=!1})}}],template:'<button class="btn {{buttonclass}} " data-ng-show="isdisabled && !isClicked" data-ng-disabled="true" >{{text}}</button><button class="btn {{buttonclass}} " data-ng-click="buttonClick()" data-ng-hide="(isdisabled && !isClicked) || isClicked" >{{text}}</button><button class="btn {{buttonclass}} " data-ng-show="isClicked" data-ng-disabled="true" ><i class="fa fa-circle-o-notch fa-spin"></i> {{spinnertext}}</button>'}})}(),function(){app.directive("configureSiteTabs",function(){return{restrict:"E",transclude:!0,replace:!0,scope:{activeTab:"@"},controller:["$scope",function(a){a.theThemeTabClass="ThemeAndStyling"==a.activeTab?"active":"",a.thePropertyTabClass="PropertyDetails"==a.activeTab?"active":"",a.thePagesTabClass="Pages"==a.activeTab?"active":"",a.theSettingsTabClass="Settings"==a.activeTab?"active":""}],template:'<div class="tabbable tabbable-custom tabbable-noborder"><ul class="nav nav-tabs"><li ng-class="theThemeTabClass"><a href="#/editsite-theme" data-toggle="tab" aria-expanded="false">Theme and Styling</a></li><li ng-class="thePropertyTabClass"><a href="#/property-overview" data-toggle="tab" aria-expanded="false">Property Details</a></li><li ng-class="thePagesTabClass"><a href="#/editsite-pages" data-toggle="tab" aria-expanded="true">Pages</a></li><li ng-class="theSettingsTabClass"><a href="#/editsite-settings" data-toggle="tab" aria-expanded="true">Settings</a></li></ul><div class="tab-content"><div class="tab-pane active"><ng-transclude></ng-transclude></div></div></div>'}})}(),function(){app.directive("pageContentContainer",function(){return{restrict:"E",transclude:!0,replace:!0,scope:{pageHeading:"@"},template:'<div class="page-container"><div class="page-head"><div class="container"><div class="page-title"><h1>{{pageHeading}}</h1></div></div></div><div class="page-content"><div class="container"><ng-transclude></ng-transclude></div></div></div>'}})}(),function(){app.directive("portletForm",function(){return{restrict:"E",transclude:!0,replace:!0,scope:{portletHeading:"@",colour:"@",faIcon:"@"},template:'<div class="portlet box {{colour}}"><div class="portlet-title"><div class="caption"><i class="fa {{faIcon}}"></i> {{portletHeading}}</div></div><div class="portlet-body form"><ng-transclude></ng-transclude></div></div>'}})}(),function(){app.directive("propertyDetailsNavigation",function(){return{restrict:"E",scope:{activeTab:"@",propertyName:"@"},controller:["$scope",function(a){a.theOverviewTabClass="Overview"==a.activeTab?"active":"",a.theLocationTabClass="Location"==a.activeTab?"active":"",a.theGalleryTabClass="Gallery"==a.activeTab?"active":"",a.theRatesTabClass="Rates"==a.activeTab?"active":"",a.theContactTabClass="Contact"==a.activeTab?"active":"",a.theReviewsTabClass="Reviews"==a.activeTab?"active":""}],template:'<div class="navbar navbar-default" role="navigation"><div class="navbar-header"><span class="navbar-brand">Configure Property: {{propertyName}} </span></div><div class="collapse navbar-collapse navbar-ex1-collapse"><ul class="nav navbar-nav"><li ng-class="theOverviewTabClass"><a href="#/property-overview">Overview</a></li><li ng-class="theLocationTabClass"><a href="#/property-location">Location</a></li><li ng-class="theGalleryTabClass"><a href="#/property-gallery">Gallery</a></li><li ng-class="theRatesTabClass"><a href="#/property-rates">Rates</a></li><li ng-class="theContactTabClass"><a href="#/property-contacts">Contact</a></li><li ng-class="theReviewsTabClass"><a href="#/property-reviews">Reviews</a></li></ul></div></div>'}})}(),function(){app.directive("defaultPanel",function(){return{restrict:"E",transclude:!0,replace:!0,scope:{panelHeading:"@"},template:'<div class="panel panel-default"><div class="panel-heading"><h4 class="panel-title">{{panelHeading}}</h4></div><div class="panel-collapse collapse in" aria-expanded="true"><div class="panel-body"><ng-transclude></ng-transclude></div></div></div>'}})}(),function(){app.directive("globalErrorFeedback",function(){return{restrict:"E",scope:{},controller:["$rootScope","$scope",function(a,b){b.hideMessage=!0,b.message="",a.$on("globalErrorEvent",function(a,c){b.message=c,b.hideMessage=!1}),a.$on("globalClearErrorEvent",function(){b.hideMessage=!0,b.message=""})}],template:'<div data-ng-hide="hideMessage" class="note note-danger note-bordered clearfix" ng-bind-html="message"></div>'}})}();