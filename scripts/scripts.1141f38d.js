"use strict";var app=angular.module("rentify",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","LocalStorageModule","angular-loading-bar","services.config","toastr","angular-data.DSCacheFactory","ui.bootstrap"]);app.config(["$httpProvider",function(a){a.interceptors.push("authInterceptorService")}]),app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html"}).when("/login",{templateUrl:"views/login.html",controller:"loginController"}).when("/signup",{templateUrl:"views/signup.html",controller:"signupController"}).when("/mysites",{templateUrl:"views/mysites.html",controller:"mysitesController"}).when("/addsite",{templateUrl:"views/addsite.html",controller:"addSiteController"}).when("/deletesite",{templateUrl:"views/deletesite.html",controller:"deletesiteController"}).when("/editsite",{templateUrl:"views/editsite.html",controller:"editsiteController"}).otherwise({redirectTo:"/"})}]),angular.module("services.config",[]).constant("configuration",{serverBaseUri:"http://rentifywebapidev01.azurewebsites.net/",clientId:"rentifyAngularMainApp",environment:"DEV"}),app.run(["authService",function(a){a.fillAuthData()}]),app.factory("authService",["$q","$injector","$location","localStorageService","configuration",function(a,b,c,d,e){var f,g=e.serverBaseUri,h={},i={isAuth:!1,userName:"",useRefreshTokens:!1},j={provider:"",userName:"",email:"",externalAccessToken:""},k=function(a){return n(),f=f||b.get("$http"),f.post(g+"api/account/register",a).then(function(a){return a})},l=function(){i.isAuth||c.path("login")},m=function(a){var c="grant_type=password&username="+a.userName+"&password="+a.password;return a.useRefreshTokens&&(c=c+"&client_id="+e.clientId),f=f||b.get("$http"),console.log("about to post to:"+g+"token"),f.post(g+"token",c,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){a.useRefreshTokens?d.set("authorizationData",{token:b.access_token,userName:a.userName,refreshToken:b.refresh_token,useRefreshTokens:!0}):d.set("authorizationData",{token:b.access_token,userName:a.userName,refreshToken:"",useRefreshTokens:!1}),i.isAuth=!0,i.userName=a.userName,i.useRefreshTokens=a.useRefreshTokens}).error(function(a,b,c,d){console.log("Error encountered logging in (authService):",a,b,d),n()})},n=function(){d.remove("authorizationData"),i.isAuth=!1,i.userName="",i.useRefreshTokens=!1},o=function(){var a=d.get("authorizationData");a&&(i.isAuth=!0,i.userName=a.userName,i.useRefreshTokens=a.useRefreshTokens)},p=function(){console.log("refreshing token...");var c=a.defer(),h=d.get("authorizationData");if(h&&h.useRefreshTokens){var i="grant_type=refresh_token&refresh_token="+h.refreshToken+"&client_id="+e.clientId;d.remove("authorizationData"),f=f||b.get("$http"),f.post(g+"token",i,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){d.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:a.refresh_token,useRefreshTokens:!0}),c.resolve(a)}).error(function(){c.reject()})}else c.reject();return c.promise},q=function(a){return f=f||b.get("$http"),f.get(g+"api/account/ObtainLocalAccessToken",{params:{provider:a.provider,externalAccessToken:a.externalAccessToken}}).success(function(a){d.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:"",useRefreshTokens:!1}),i.isAuth=!0,i.userName=a.userName,i.useRefreshTokens=!1}).error(function(){n()})},r=function(a){return f=f||b.get("$http"),f.post(g+"api/account/registerexternal",a).success(function(a){d.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:"",useRefreshTokens:!1}),i.isAuth=!0,i.userName=a.userName,i.useRefreshTokens=!1}).error(function(){n()})};return h.saveRegistration=k,h.login=m,h.logOut=n,h.fillAuthData=o,h.authentication=i,h.refreshToken=p,h.obtainAccessToken=q,h.externalAuthData=j,h.registerExternal=r,h.redirectToLoginIfNotAuthenticated=l,h}]),app.factory("authInterceptorService",["$q","$location","$injector","localStorageService",function(a,b,c,d){var e,f={},g=function(a){a.headers=a.headers||{};var b=d.get("authorizationData");return b&&(a.headers.Authorization="Bearer "+b.token),a},h=function(d){var e=a.defer();if(401===d.status){var f=c.get("authService");f.refreshToken().then(function(){i(d.config,e)},function(a){console.log("failed to refresh token: ",a),f.logOut(),b.path("/login"),e.reject(d)})}else e.reject(d);return e.promise},i=function(a,b){e=e||c.get("$http"),e(a).then(function(a){b.resolve(a)},function(a){b.reject(a)})};return f.request=g,f.responseError=h,f}]),app.factory("tokensManagerService",["$http","configuration",function(a,b){var c=b.serverBaseUri,d={},e=function(){return a.get(c+"api/RefreshTokens").then(function(a){return a})},f=function(b){return a["delete"](c+"api/refreshtokens/?tokenid="+b).then(function(a){return a})};return d.deleteRefreshTokens=f,d.getRefreshTokens=e,d}]),function(){function a(a,b,c,d,e){function f(){var c=b.defer(),d=(new Date).getTime(),f=e.get(k);return f.get(k)?c.resolve(f.get(k)):a.post(l+"api/mysites").success(function(a){console.log("time taken for mysites request: "+((new Date).getTime()-d)+"ms"),f.put(k,a),c.resolve(a)}),c.promise}function g(){return a.post(l+"api/mysites").success(function(a){var b=e.get(k);return b.put(k,a),a})}function h(b){return a.post(l+"api/mysites/add",b).success(function(){var a=e.get(k),c=a.get(k);c.push(b),a.put(k,c)})}function i(b){return a["delete"](l+"api/mysites/delete?uniqueId="+b).success(function(){for(var a=e.get(k),c=a.get(k),d=c.length-1;d>=0;d--)c[d].uniqueId===b&&c.splice(d,1);a.put(k,c)})}c.redirectToLoginIfNotAuthenticated();var j,k="mysites",l=d.serverBaseUri;e(k,{maxAge:9e4,cacheFlushInterval:6e5,deleteOnExpire:"aggressive"});var m={};return m.getMySites=f,m.addSite=h,m.deleteSite=i,m.setSelectedSite=function(a){j=a},m.getSelectedSite=function(){return j},m.clearSelectedSite=function(){j={}},m.refreshMySites=g,m}app.factory("sitesService",["$http","$q","authService","configuration","DSCacheFactory",a])}(),function(){function a(a){function b(){return(new Date).toUTCString()}var c={positionClass:"toast-bottom-right"},d={};return d.info=function(d){a.info(d,b(),c)},d.error=function(d){a.error(d,b(),c)},d.success=function(d){a.success(d,b(),c)},d.warning=function(d){a.warning(d,b(),c)},d}angular.module("rentify").factory("notificationService",["toastr",a])}(),function(){function a(a,b,c,d,e,f){function g(a,b){for(var c=e.get(i),d=c.get(b),f=d.length-1;f>=0;f--)d[f].id===a.id&&d.splice(f,1);c.put(i,d)}function h(a,b){g(a,b);var c=e.get(i),d=c.get(b);d.push(a),c.put(b,d)}c.redirectToLoginIfNotAuthenticated();var i="pages",j=d.serverBaseUri,k={};return e(i,{maxAge:9e4,cacheFlushInterval:6e5,deleteOnExpire:"aggressive"}),k.getPages=function(){var c=f.getSelectedSite().uniqueId,d=b.defer(),g=(new Date).getTime(),h=e.get(i);return h.get(c)?d.resolve(h.get(c)):a.post(j+"api/"+c+"/pages").success(function(a){console.log("time taken for pages request: "+((new Date).getTime()-g)+"ms"),h.put(c,a),d.resolve(a)}),d.promise},k.refreshPages=function(){var b=f.getSelectedSite().uniqueId;return a.post(j+"api/"+b+"/pages").success(function(a){var c=e.get(i);return c.put(b,a),a})},k.savePage=function(b){var c=f.getSelectedSite().uniqueId;return a.post(j+"api/"+c+"/save",b).success(function(a){h(a,c)})},k.deletePage=function(b){var c=f.getSelectedSite().uniqueId;return a["delete"](j+"api/"+c+"/delete?webPageId="+b.id).success(function(){g(b,c)})},k}app.factory("pagesService",["$http","$q","authService","configuration","DSCacheFactory","sitesService",a])}(),function(){function a(a,b,c,d){var e={};e.environment=d.environment,e.logOut=function(){c.logOut(),b.path("/home")},e.authentication=c.authentication,a.vm=e}app.controller("indexController",["$scope","$location","authService","configuration",a])}(),app.controller("loginController",["$scope","$location","configuration","authService",function(a,b,c,d){var e={},f=c.serverBaseUri,g=c.clientId;e.loginData={userName:"",password:"",useRefreshTokens:!1},e.message="",e.login=function(){return console.log("entering login function"),d.login(e.loginData).success(function(){b.path("/mysites")}).error(function(a,b,c,d){console.log("Error encountered logging in:",a,b,d),e.message=a.error_description})},e.authExternalProvider=function(b){var c=location.protocol+"//"+location.host+"/authcomplete.html",d=f+"api/Account/ExternalLogin?provider="+b+"&response_type=token&client_id="+g+"&redirect_uri="+c;window.$windowScope=a;window.open(d,"Authenticate Account","location=0,status=0,width=600,height=750")},a.authCompletedCB=function(c){a.$apply(function(){if("False"==c.haslocalaccount)console.log("external account is not linked to a local account, linking..."),d.logOut(),d.externalAuthData={provider:c.provider,userName:c.external_user_name,email:c.external_email,externalAccessToken:c.external_access_token},a.registerData={userName:d.externalAuthData.email,email:d.externalAuthData.email,provider:d.externalAuthData.provider,externalAccessToken:d.externalAuthData.externalAccessToken},console.log("about to post registerData: ",a.registerData),d.registerExternal(a.registerData).success(function(){b.path("/orders")}).error(function(a,b,c,d){console.log("Error encountered associating external login with local app account:",a,b,d),e.message=a.error_description});else{console.log("external account is linked to a local account, logging in...");var f={provider:c.provider,externalAccessToken:c.external_access_token};d.obtainAccessToken(f).then(function(){b.path("/orders")},function(a,b,c,d){console.log("Error encountered logging in (authCompletedCB): ",a,b,d),e.message=a.error_description})}})},a.vm=e}]),app.controller("signupController",["$scope","$location","$timeout","authService",function(a,b,c,d){var e={};e.savedSuccessfully=!1,e.message="",e.registration={userName:"",email:"",password:"",confirmPassword:""},e.signUp=function(){return d.saveRegistration(e.registration).then(function(){e.savedSuccessfully=!0,e.message="User has been registered successfully, you will be redirected to login page in 2 seconds.",f()},function(a){var b=[];for(var c in a.data.modelState)for(var d=0;d<a.data.modelState[c].length;d++)b.push(a.data.modelState[c][d]);e.message="Failed to register user due to:"+b.join(" ")})};var f=function(){var a=c(function(){c.cancel(a),b.path("/login")},2e3)};a.vm=e}]),function(){function a(a,b,c,d){c.redirectToLoginIfNotAuthenticated();var e={};e.sites=[],e.message="",e.loadingSites=!0,e.getSites=function(){e.loadingSites=!0,d.getMySites().then(function(a){e.sites=a,e.loadingSites=!1},function(a,b,c,d){console.log("Getting MySites failed: ",a,b,d),e.message="Getting My Sites failed. "+(a.message?a.message:""),e.loadingSites=!1})},e.refreshSites=function(){return e.loadingSites=!0,d.refreshMySites().success(function(a){e.sites=a,e.loadingSites=!1}).error(function(){e.message="Refreshing My Sites failed.",e.loadingSites=!1})},e.deleteSite=function(a){d.setSelectedSite(a),b.path("deletesite")},e.editSite=function(a){d.setSelectedSite(a),b.path("editsite")},e.getSites(),a.vm=e}app.controller("mysitesController",["$scope","$location","authService","sitesService",a])}(),function(){function a(a,b,c,d,e){c.redirectToLoginIfNotAuthenticated();var f={};f.message="",f.site={name:"",uniqueId:""},f.addSite=function(){return d.addSite(f.site).success(function(){e.success("New site ["+f.site.name+"] successully added."),b.path("mysites")}).error(function(a,b,c,d){console.log("Adding new site failed: ",a,b,d),f.message="Adding new site failed. "+(a.message?a.message:"")})},a.vm=f}app.controller("addSiteController",["$scope","$location","authService","sitesService","notificationService",a])}(),function(){function a(a,b,c,d,e){c.redirectToLoginIfNotAuthenticated();var f={};f.message="",f.site=d.getSelectedSite(),f.site||b.path("mysites"),f.cancel=function(){d.clearSelectedSite(),b.path("mysites")},f.deleteSite=function(){return d.deleteSite(f.site.uniqueId).success(function(){e.success("The site: "+f.site.name+" was successully deleted."),f.cancel()}).error(function(a,b,c,d){console.log("Error encountered deleting site:",a,b,d),f.message=a.error_description})},a.vm=f}app.controller("deletesiteController",["$scope","$location","authService","sitesService","notificationService",a])}(),function(){function a(a,b,c,d){c.redirectToLoginIfNotAuthenticated();var e={};e.site=d.getSelectedSite(),a.vm=e}app.controller("editsiteController",["$scope","$location","authService","sitesService",a])}(),function(){function a(a,b,c,d,e,f,g){function h(){i.page={},i.configurePage=!1}if(d.redirectToLoginIfNotAuthenticated(),!e.getSelectedSite())return void b.path("mysites");var i={};i.message="",i.configurePage=!1,i.pages=[],i.page,console.log("pages: ",i.pages),i.addPage=function(){var a={menuText:"",title:"",content:""};i.page=a,i.configurePage=!0},i.editPage=function(a){i.page=a,i.configurePage=!0},i.deletePage=function(a){i.page=a;var b=c.open({templateUrl:"deletePageModalContent.html",controller:"SimpleDeleteModalInstanceController",resolve:{objToDelete:function(){return i.page}}});b.result.then(function(){f.deletePage(i.page).success(function(){g.success("Successfully deleted page titled: "+i.page.title)})},function(){})},i.savePage=function(){return f.savePage(i.page).success(function(){h()}).error(function(a,b,c,d){console.log("Error encountered saving page: ",a,b,d);var e="";a.error_description&&(e="Error Description: "+a.error_description),a.message&&(e=(e?e+", Message: ":"Message: ")+a.message),a.messageDetail&&(e=e+", Message Detail: "+a.messageDetail),a.exceptionMessage&&(e=e+", Exception Message: "+a.exceptionMessage),e||(e="Error encountered trying to save the page details."),i.message=e})},i.cancel=function(){console.log("switching back"),h()},i.getPages=function(){f.getPages(e.getSelectedSite().uniqueId).then(function(a){i.pages=a},function(){console.log("Error encountered getting pages.")})},i.getPages(),a.vm=i}app.controller("PagesController",["$scope","$location","$modal","authService","sitesService","pagesService","notificationService",a])}(),function(){function a(a,b,c){var d={};d.objToDelete=c,d.ok=function(){b.close()},d.cancel=function(){b.dismiss("cancel")},a.vm=d}app.controller("SimpleDeleteModalInstanceController",["$scope","$modalInstance","objToDelete",a])}(),function(){app.directive("spinnerButton",function(){return{restrict:"E",scope:{buttonclass:"@",text:"@",spinnertext:"@",isdisabled:"=",click:"&"},controller:["$scope",function(a){a.buttonText=a.text,a.isClicked=!1,a.buttonClick=function(){a.buttonText=a.spinnertext,a.isClicked=!0,a.click().then(function(){a.buttonText=a.text,a.isClicked=!1},function(){a.buttonText=a.text,a.isClicked=!1})}}],template:'<button class="btn {{buttonclass}} " data-ng-click="buttonClick()" data-ng-disabled="isdisabled || isClicked" ><i class="fa fa-circle-o-notch fa-spin" data-ng-show="isClicked"></i> {{buttonText}}</button>'}})}();